version: "3.4"

services:
  rp01:
    image: nginx:latest
    hostname: rp01
    container_name: rp01
    depends_on:
      - gw01
      - gw02
      - csa
      - csb
      - csc
    ports:
      - "8500:8500"
      - "8510:8510"
      - "8520:8520"
      - "5000:5000"
    networks:
      - net01
    volumes:
      - ./docker-files/nginx/nginx.conf:/etc/nginx/nginx.conf
  csa:
    image: consul-demo-consul:latest
    #command: consul agent -config-file=/etc/config/consul.json
    # command: consul agent -server -ui -node=csa -retry-join csb -retry-join csc -datacenter=consuldemo01 -data-dir=/consul/data -bootstrap-expect=3 -client=0.0.0.0
    hostname: csa
    container_name: csa
    volumes:
      - ./docker-files/consul/csb/mnt/data:/consul/data
      - ./docker-files/consul/all/policy:/consul/policy
    networks:
      - net01
    # volumes:
  csb:
    image: consul-demo-consul:latest
    # command: consul agent -config-file=/etc/config/consul.json
    # command: consul agent -server -ui -node=csb -retry-join csa -retry-join csc -datacenter=consuldemo01 -data-dir=/consul/data -bootstrap-expect=3 -client=0.0.0.0
    hostname: csb
    container_name: csb
    volumes:
      - ./docker-files/consul/csb/mnt/data:/consul/data
      - ./docker-files/consul/all/policy:/consul/policy
    networks:
      - net01
    # volumes:
    #   - D:/temp/consuldemo/csb:/mnt/data/consul
  csc:
    image: consul-demo-consul:latest
    # command: consul agent -config-file=/etc/config/consul.json
    # command: consul agent -server -ui -node=csc -retry-join csa -retry-join csb -datacenter=consuldemo01 -data-dir=/consul/data -bootstrap-expect=3 -client=0.0.0.0
    hostname: csc
    container_name: csc
    volumes:
      - ./docker-files/consul/csb/mnt/data:/consul/data
      - ./docker-files/consul/all/policy:/consul/policy
      # - ./docker-files/consul/consul.server.json:/etc/config/consul.json
      # - ./docker-files/consul/csc/mnt/data:/mnt/data/consul
      # - ./docker-files/consul/all/policy:/mnt/data/consul/policy
    networks:
      - net01
    # volumes:
    #   - D:/temp/consuldemo/csc:/mnt/data/consul
#   cc1:
#     image: consul:latest
#     command: consul agent -client 0.0.0.0 -ui -node=cc1 -retry-join csb -datacenter=consuldemo01 -data-dir=/mnt/data/consul
#     hostname: cc1
#     container_name: cc1
#     networks:
#       - net01
#     volumes:
#       - D:/temp/consuldemo/cc1:/mnt/data/consul
#   cc2:
#     image: consul:latest
#     command: consul agent -client 0.0.0.0 -ui -node=cc2 -retry-join csc -datacenter=consuldemo01 -data-dir=/mnt/data/consul
#     hostname: cc2
#     container_name: cc2
#     networks:
#       - net01
#     volumes:
#       - D:/temp/consuldemo/cc2:/mnt/data/consul
  gw01:
    image: consul-demo-gw
    container_name: gw01
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      APP_LOG_PATH: logs/
    networks:
      - net01
  gw02:
    image: consul-demo-gw
    container_name: gw02
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      APP_LOG_PATH: logs/
    networks:
      - net01
  app1:
    image: consul-demo-app
    hostname: app1
    container_name: app1
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      APP_CONSUL_HOST: localhost:8500
      APP_SERVICE_NAME: benefit
    depends_on:
      - rp01
    networks:
      - net01
    volumes:
        - ./docker-files/consul/consul.client.json:/etc/config/consul.json
        - ./docker-files/supervisor/conf.d:/etc/supervisor/conf.d
        - ./docker-files/consul/client/ssl:/mnt/data/consul/ssl
  app2:
    image: consul-demo-app
    hostname: app2
    container_name: app2
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      APP_CONSUL_HOST: localhost:8500
      APP_SERVICE_NAME: invoice
    depends_on:
      - rp01
    networks:
      - net01
    volumes:
        - ./docker-files/consul/consul.client.json:/etc/config/consul.json
        - ./docker-files/supervisor/conf.d:/etc/supervisor/conf.d
        - ./docker-files/consul/client/ssl:/mnt/data/consul/ssl
  app3:
    image: consul-demo-app
    hostname: app3
    container_name: app3
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      APP_CONSUL_HOST: localhost:8500
      APP_SERVICE_NAME: invoice
    networks:
      - net01
    volumes:
        - ./docker-files/consul/consul.client.json:/etc/config/consul.json
        - ./docker-files/supervisor/conf.d:/etc/supervisor/conf.d
        - ./docker-files/consul/client/ssl:/mnt/data/consul/ssl
  app4:
    image: consul-demo-app
    hostname: app4
    container_name: app4
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      APP_CONSUL_HOST: localhost:8500
      APP_SERVICE_NAME: insurant
    depends_on:
      - rp01
    networks:
      - net01
    volumes:
        - ./docker-files/consul/consul.client.json:/etc/config/consul.json
        - ./docker-files/supervisor/conf.d:/etc/supervisor/conf.d
        - ./docker-files/consul/client/ssl:/mnt/data/consul/ssl
  app5:
    image: consul-demo-app
    hostname: app5
    container_name: app5
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      APP_CONSUL_HOST: localhost:8500
      APP_SERVICE_NAME: insurant
    depends_on:
      - rp01
    networks:
      - net01
    volumes:
        - ./docker-files/consul/consul.client.json:/etc/config/consul.json
        - ./docker-files/supervisor/conf.d:/etc/supervisor/conf.d
        - ./docker-files/consul/client/ssl:/mnt/data/consul/ssl

networks:
  net01:
