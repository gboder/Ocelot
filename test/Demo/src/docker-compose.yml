version: '3.4'

services:
    rp01:
        image: nginx:latest
        hostname: rp01
        container_name: rp01
        ports:
            - "8510:8510"
            - "8520:8520"
        networks:
            - net01
        volumes:
            - D:/temp/consuldemo/nginx/nginx.conf:/etc/nginx/nginx.conf
    consulServerA:
        image: consul:latest
        command: consul agent -server -ui -node=consulServerA -retry-join consulServerB -retry-join consulServerC -datacenter=consuldemo01 -data-dir=/mnt/data/consul -bootstrap-expect=3 -http-port 8500
        hostname: consulServerA
        container_name: consulServerA
        networks: 
            - net01
        volumes:
            - D:/temp/consuldemo/consulServerA:/mnt/data/consul
    consulServerB:
        image: consul:latest
        command: consul agent -server -ui -node=consulServerB -retry-join consulServerA -retry-join consulServerC -datacenter=consuldemo01 -data-dir=/mnt/data/consul -bootstrap-expect=3 -http-port 8500
        hostname: consulServerB
        container_name: consulServerB
        networks: 
            - net01
        volumes:
            - D:/temp/consuldemo/consulServerB:/mnt/data/consul
    consulServerC:
        image: consul:latest
        command: consul agent -server -ui -node=consulServerC -retry-join consulServerA -retry-join consulServerB -datacenter=consuldemo01 -data-dir=/mnt/data/consul -bootstrap-expect=3 -http-port 8500
        hostname: consulServerC
        container_name: consulServerC
        networks: 
            - net01
        volumes:
            - D:/temp/consuldemo/consulServerC:/mnt/data/consul
    consulServerD:
        image: consul:latest
        command: consul agent -server -ui -node=consulServerD -retry-join consulServerA -retry-join consulServerB -datacenter=consuldemo01 -data-dir=/mnt/data/consul -bootstrap-expect=3 -http-port 8500
        hostname: consulServerD
        container_name: consulServerD
        networks: 
            - net01
        volumes:
            - D:/temp/consuldemo/consulServerD:/mnt/data/consul
    consulServerE:
        image: consul:latest
        command: consul agent -server -ui -node=consulServerE -retry-join consulServerA -retry-join consulServerB -datacenter=consuldemo01 -data-dir=/mnt/data/consul -bootstrap-expect=3 -http-port 8500
        hostname: consulServerE
        container_name: consulServerE
        networks: 
            - net01
        volumes:
            - D:/temp/consuldemo/consulServerE:/mnt/data/consul
    consulClient01:
        image: consul:latest
        command: consul agent -client 0.0.0.0 -ui -node=consulClient01 -retry-join consulServerB -datacenter=consuldemo01 -data-dir=/mnt/data/consul
        hostname: consulClient01
        container_name: consulClient01
        networks: 
            - net01
        volumes:
            - D:/temp/consuldemo/consulClient01:/mnt/data/consul
    consulClient02:
        image: consul:latest
        command: consul agent -client 0.0.0.0 -ui -node=consulClient02 -retry-join consulServerB -datacenter=consuldemo01 -data-dir=/mnt/data/consul
        hostname: consulClient02
        container_name: consulClient02
        networks: 
            - net01
        volumes:
            - D:/temp/consuldemo/consulClient02:/mnt/data/consul
    gw:
        image: consul-demo-gw
        container_name: gw
        environment: 
            ASPNETCORE_ENVIRONMENT: Development
            APP_LOG_PATH: logs/
        ports: 
            - "5000:80"
        networks: 
            - net01
    app1:
        image: consul-demo-app
        hostname: app1
        container_name: app1
        environment: 
            ASPNETCORE_ENVIRONMENT: Development
            APP_CONSUL_HOST: consulClient01:8500
        networks: 
            - net01
    app2:
        image: consul-demo-app
        hostname: app2
        container_name: app2
        environment: 
            ASPNETCORE_ENVIRONMENT: Development
            APP_CONSUL_HOST: consulClient02:8500
        networks: 
            - net01
    app3:
        image: consul-demo-app
        hostname: app3
        container_name: app3
        environment: 
            ASPNETCORE_ENVIRONMENT: Development
            APP_CONSUL_HOST: consulClient01:8500
        networks: 
            - net01
    app4:
        image: consul-demo-app
        hostname: app4
        container_name: app4
        environment: 
            ASPNETCORE_ENVIRONMENT: Development
            APP_CONSUL_HOST: consulClient02:8500
        networks: 
            - net01
            
networks:
    net01: